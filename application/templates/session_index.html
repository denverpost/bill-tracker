{% extends "base.html" %}
{% block style %}{% endblock style %}
{% block breadcrumbs %}{{ super() }}
&rsaquo; <a href="http://www.denverpost.com/bill-tracker">Bill Tracker</a>{% endblock breadcrumbs %}
{% block head %}
<!-- DATATABLES -->
<link rel="stylesheet" type="text/css" href="{{response.app.url_root}}static/css/datatables.css"/>
<link href="https://cdn.datatables.net/responsive/2.0.1/css/responsive.dataTables.min.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.datatables.net/r/zf-5.5.2/jqc-1.11.3,dt-1.10.8/datatables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.0.1/js/dataTables.responsive.js"></script>
<script src="http://extras.denverpost.com/summercamps/2016/ColumnFilterWidgets.js"></script>
<style>
.widget-2 {
    width: 20%;
    float: left;
    margin-right: 20px;
}
.widget-3 {
    width: 30%;
    float: left;
}
</style>
{% endblock head %}
{% block content %}
{#
<p>We're tracking bills in the Colorado General Assembly for these sessions:</p>
<ul>
{% for item in response.app.sessions|reverse %}
    <li><a href="{{item}}/">{{item}}</a></li>
{%- endfor %}
</ul>

<h2 id="search">Search Legislation, 2011-2016</h2>
<div class="row">
    <div class="large-12 columns">
        <table id="bill-table" class="stripe table-bordered">
            <thead>
                <tr>
					<th class="all">Title</th>
					<th class="all">Session</th>
				</tr>
            </thead>
            <tfoot>
            </tfoot>
        </table>
    </div>
</div>

#}
<script>
var data = {{response.json|safe}};

$('#bill-table').dataTable( { 
    data: data,
    order: [ 0, "asc" ],
    paging: true,
    pagingType: 'numbers',
    pageLength: 50,
    responsive: true,
    columns: [ 
        { "data": "title",
          "render": function(data, type, full) {
              return "<a href='" + full['url'] + "'>" + data + "</a>";
          }
        },
        { "data": "session" }
	],
    autoWidth: false,
    //deferRender: true,
    dom: '<"top">Wf<"clear">tip',
    // https://github.com/cyberhobo/ColumnFilterWidgets
    oColumnFilterWidgets: {
        aiExclude: [0,1],
        // sSeparator: ',  ',
        bGroupTerms: false,
    }
} );

</script>

<h2 id="generator">Colorado Bill Title Generator</h2>
<p>Make up your own Colorado legislation: Push the button for a fake Colorado bill title, built on the words of existing Colorado legislation.</p>
<style type="text/css">
.hide { display:none; }
.active { display:block!important; }

#bill-gen
{
    width: 90%;
    margin: 5% auto;
}
h3
{
    width: 100%;
    text-align: center;
    color: rgb(0,0,70);
}
.active > div
{
    border-image: url("{{response.app.url_root}}static/img/border-top.gif") 100 10 round;
    border-top: 50px solid transparent;
    border-bottom: 0 solid;
}
.active
{
    border-image: url("{{response.app.url_root}}static/img/border-bottom.gif") 100 10 round;
    border-top: 0 solid;
    border-bottom: 50px solid transparent;
}
#credit
{
    text-align: right;
    color: #aaa;
}
#interface
{
    text-align: center;
}
#interface button
{
    padding: 20px;
    margin: 20px;
}
.borderless
{
}
.multiple-borders
{
  -webkit-box-shadow:
            0px 0px 0px 2px rgba(0,0,0,0.6),
                0px 0px 0px 14px #fff,
                0px 0px 0px 18px rgba(0,0,0,0.2),
                6px 6px 8px 17px #555;
  
     -moz-box-shadow:
            0px 0px 0px 2px rgba(0,0,0,0.6),
                0px 0px 0px 14px #fff,
                0px 0px 0px 18px rgba(0,0,0,0.2),
                6px 6px 8px 17px #555;
  
          box-shadow:
            0px 0px 0px 2px rgba(0,0,0,0.6),
                0px 0px 0px 14px #fff,
                0px 0px 0px 18px rgba(0,0,0,0.2),
                6px 6px 8px 17px #555;
}
.inset
{
}
</style>
<script src="{{response.app.url_root}}static/js/html2canvas.js"></script>

<div id="bill-gen" class="hide multiple-borders">
    <div>
        <h3 id="title"></h3>
        <p id="credit" class="hide">Colorado Bill Tracker, http://www.denverpost.com/bill-tracker</p>
    </div>
</div>

<div id="interface">
    <button id="generate" onClick="markov.load_title('bill-gen'); $('#save-image').removeClass('hide');">Generate New Bill</button>
    <button id="save-image" class="hide" onClick="save_image();">Save The Bill</button>
</div>
<script>
function convert_to_slug(text){
    return text
        .toLowerCase()
        .replace(/[^\w ]+/g,'')
        .replace(/ +/g,'-');
}
function save_image()
{
    html2canvas($('#bill-gen'), {
        allowTaint: true,
        onrendered: function(canvas) {
            $('#credit').removeClass('hide');
            //$('.active, .active > div').addClass('borderless');

            document.body.appendChild(canvas);
            window.oCanvas = document.getElementsByTagName("canvas");
            window.oCanvas = window.oCanvas[0];
            var strDataURI = window.oCanvas.toDataURL();

            var quote = $('h3').text().split(' ', 5);
            var filename = convert_to_slug(quote.join(' '));

            var a = $("<a>").attr("href", strDataURI).attr("download", "bill-" + filename + ".png").appendTo("body");
            a[0].click();
            a.remove();

            $('#download').attr('href', strDataURI).attr('target', '_blank');
            $('#download').trigger('click');

            //$('.active, .active > div').removeClass('borderless');
            $('#credit').addClass('hide');
        }
    });
}
// Adapted from http://www.soliantconsulting.com/blog/2013/02/title-generator-using-markov-chains
var markov = {
    titles: data,
    terminals: {},
    startwords: [],
    wordstats: {},
    init: function() {
        var len = this.titles.length;
        for (var i = 0; i < len; i++)
        {
            var words = this.titles[i]['title'].split(' ');
            this.terminals[words[words.length-1]] = true;
            this.startwords.push(words[0]);
            var wordlen = words.length;
            for (var j = 0; j < wordlen - 1; j++)
            {
                if (this.wordstats.hasOwnProperty(words[j])) {
                    this.wordstats[words[j]].push(words[j+1]);
                } else {
                    this.wordstats[words[j]] = [words[j+1]];
                }
            }
        }
    },
    choice: function (a) {
        var i = Math.floor(a.length * Math.random());
        return a[i];
    },
    make_title: function (min_length) {
        var word = this.choice(this.startwords);
        var title = [word];
        while (this.wordstats.hasOwnProperty(word)) {
            var next_words = this.wordstats[word];
            word = this.choice(next_words);
            title.push(word);
            if (title.length > min_length && this.terminals.hasOwnProperty(word)) break;
        }
        if (title.length < min_length) return this.make_title(min_length);
        return title.join(' ');
    },
    load_title: function(id) {
        var title = this.make_title(3 + Math.floor(3 * Math.random()));
        $('#' + id + ' h3').text(title);
        $('#' + id).addClass('active');
    }
}
markov.init();
</script>

{% endblock content %}
